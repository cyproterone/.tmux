#!/usr/bin/env bash

set -eu
set -o pipefail


cd "$(dirname "$0")/.." || exit 1


plugins="$(rg '^set -g @plugin' < tmux.conf)"
readarray -t repos < <(rg --replace '$1' -- 'set -g @plugin "([^"]+)"' <<< "$plugins")


cd 'plugins' || exit 1


git_update() {
  local repo="$1"
  local dest="$(rg --replace '' -- '[^/]+/' <<< "$repo")"
  if [[ -d "$dest" ]]
  then
    (
      cd "$dest" || exit 1
      git pull --no-rebase
    )
  else
    local uri="$(printf 'https://github.com/%s.git' "$repo")"
    git clone --depth=1 "$uri"
  fi
}


for repo in "${repos[@]}"
do
  printf '%s\n' "$repo"
  git_update "$repo"
done
